package util

import (
	"fmt"
	"sync"
)

// 支持的语言
const (
	LangZh = "zh" // 中文
	LangEn = "en" // 英文
)

// 语言包
var messages = map[string]map[string]string{
	LangZh: {
		"success":                         "成功",
		"error":                           "错误",
		"invalid_request":                 "无效的请求",
		"unauthorized":                    "未授权",
		"forbidden":                       "禁止访问",
		"not_found":                       "未找到",
		"internal_server_error":           "服务器内部错误",
		"invalid_credentials":             "无效的凭据",
		"user_not_found":                  "用户未找到",
		"email_already_exists":            "邮箱已存在",
		"invalid_email_format":            "无效的邮箱格式",
		"password_too_short":              "密码太短",
		"password_too_long":               "密码太长",
		"invalid_birthday_format":         "无效的生日格式",
		"invalid_gender":                  "无效的性别",
		"bazi_calculation_failed":         "八字计算失败",
		"ai_service_unavailable":          "AI服务不可用",
		"invalid_master_id":               "无效的大师ID",
		"master_not_found":                "大师未找到",
		"invalid_chat_id":                 "无效的聊天ID",
		"chat_not_found":                  "聊天未找到",
		"invalid_order_id":                "无效的订单ID",
		"order_not_found":                 "订单未找到",
		"invalid_payment_method":          "无效的支付方式",
		"payment_failed":                  "支付失败",
		"insufficient_balance":            "余额不足",
		"invalid_invite_code":             "无效的邀请码",
		"invite_code_expired":             "邀请码已过期",
		"invite_code_used":                "邀请码已使用",
		"file_upload_failed":              "文件上传失败",
		"invalid_file_format":             "无效的文件格式",
		"file_too_large":                  "文件太大",
		"network_error":                   "网络错误",
		"service_temporarily_unavailable": "服务暂时不可用",
		"maintenance_mode":                "维护模式",
		"feature_disabled":                "功能已禁用",
		"rate_limit_exceeded":             "请求频率超限",
		"invalid_token":                   "无效的令牌",
		"token_expired":                   "令牌已过期",
		"token_revoked":                   "令牌已撤销",
		"session_expired":                 "会话已过期",
		"invalid_permissions":             "无效的权限",
		"account_locked":                  "账户已锁定",
		"account_disabled":                "账户已禁用",
		"verification_required":           "需要验证",
		"email_not_verified":              "邮箱未验证",
		"phone_not_verified":              "手机未验证",
		"invalid_verification_code":       "无效的验证码",
		"verification_code_expired":       "验证码已过期",
		"too_many_attempts":               "尝试次数过多",
		"please_try_again_later":          "请稍后再试",
		"operation_successful":            "操作成功",
		"operation_failed":                "操作失败",
		"data_saved":                      "数据已保存",
		"data_deleted":                    "数据已删除",
		"data_updated":                    "数据已更新",
		"no_data_found":                   "未找到数据",
		"invalid_parameters":              "无效的参数",
		"missing_required_parameters":     "缺少必需的参数",
		"invalid_data_format":             "无效的数据格式",
		"data_validation_failed":          "数据验证失败",
		"database_error":                  "数据库错误",
		"connection_failed":               "连接失败",
		"timeout_error":                   "超时错误",
		"configuration_error":             "配置错误",
		"system_error":                    "系统错误",
		"token_generation_failed":         "令牌生成失败",
		"password_set_failed":             "密码设置失败",
		"user_creation_failed":            "用户创建失败",
		"invalid_user_id_format":          "无效的用户ID格式",
		"unknown_error":                   "未知错误",
		// Additional common messages
		"chart_created":                   "已创建排盘记录",
		"submit_failed":                   "提交失败",
		"cache_cleared":                   "缓存已清除",
		"hint":                            "提示",
		"input":                           "输入",
		"chinese":                         "中文",
		// 支付相关
		"payment_successful":              "支付成功",
		"payment_pending":                 "支付处理中",
		"payment_cancelled":               "支付已取消",
		"payment_refunded":                "已退款",
		"payment_timeout":                 "支付超时",
		"payment_amount_invalid":          "无效的支付金额",
		"payment_currency_invalid":        "无效的货币",
		"payment_gateway_error":           "支付网关错误",
		"payment_processing_error":        "支付处理错误",
		"payment_authorization_failed":    "支付授权失败",
		"payment_capture_failed":          "支付捕获失败",
		"payment_refund_failed":           "退款失败",
		"payment_void_failed":             "支付作废失败",
		"payment_dispute_created":         "支付争议已创建",
		"payment_dispute_resolved":        "支付争议已解决",
		"payment_dispute_rejected":        "支付争议被拒绝",
		"subscription_created":            "订阅已创建",
		"subscription_updated":            "订阅已更新",
		"subscription_cancelled":          "订阅已取消",
		"subscription_renewed":            "订阅已续费",
		"subscription_expired":            "订阅已过期",
		"subscription_not_found":          "订阅未找到",
		"subscription_already_exists":     "订阅已存在",
		"subscription_plan_not_found":     "订阅套餐未找到",
		"subscription_plan_inactive":      "订阅套餐未激活",
		"subscription_upgrade_failed":     "订阅升级失败",
		"subscription_downgrade_failed":   "订阅降级失败",
		"membership_created":              "会员已创建",
		"membership_updated":              "会员已更新",
		"membership_cancelled":            "会员已取消",
		"membership_expired":              "会员已过期",
		"membership_not_found":            "会员未找到",
		"membership_already_exists":       "会员已存在",
		"membership_plan_not_found":       "会员套餐未找到",
		"membership_plan_inactive":        "会员套餐未激活",
		"membership_upgrade_failed":       "会员升级失败",
		"membership_downgrade_failed":     "会员降级失败",
		"invoice_created":                 "发票已创建",
		"invoice_updated":                 "发票已更新",
		"invoice_cancelled":               "发票已取消",
		"invoice_paid":                    "发票已支付",
		"invoice_overdue":                 "发票已逾期",
		"invoice_not_found":               "发票未找到",
		"invoice_already_exists":          "发票已存在",
		"invoice_already_paid":            "发票已支付",
		"invoice_already_cancelled":       "发票已取消",
		"refund_created":                  "退款已创建",
		"refund_updated":                  "退款已更新",
		"refund_approved":                 "退款已批准",
		"refund_rejected":                 "退款已拒绝",
		"refund_processed":                "退款已处理",
		"refund_not_found":                "退款未找到",
		"refund_already_exists":           "退款已存在",
		"refund_already_processed":        "退款已处理",
		"refund_amount_invalid":           "无效的退款金额",
		"refund_reason_required":          "退款原因是必需的",
		"order_created":                   "订单已创建",
		"order_updated":                   "订单已更新",
		"order_cancelled":                 "订单已取消",
		"order_paid":                      "订单已支付",
		"order_shipped":                   "订单已发货",
		"order_delivered":                 "订单已送达",
		"order_refunded":                  "订单已退款",
		"order_already_exists":            "订单已存在",
		"order_already_paid":               "订单已支付",
		"order_already_cancelled":          "订单已取消",
		"order_amount_invalid":            "无效的订单金额",
		"order_items_required":            "订单项目是必需的",
		"coupon_created":                  "优惠券已创建",
		"coupon_updated":                  "优惠券已更新",
		"coupon_deleted":                  "优惠券已删除",
		"coupon_activated":                "优惠券已激活",
		"coupon_deactivated":              "优惠券已停用",
		"coupon_not_found":                "优惠券未找到",
		"coupon_already_exists":           "优惠券已存在",
		"coupon_expired":                  "优惠券已过期",
		"coupon_used":                     "优惠券已使用",
		"coupon_usage_limit_exceeded":     "优惠券使用次数已超限",
		"coupon_invalid_for_user":         "优惠券对该用户无效",
		"coupon_invalid_for_product":      "优惠券对该产品无效",
		"coupon_minimum_amount_not_met":   "未达到最低消费金额",
		"gift_card_created":               "礼品卡已创建",
		"gift_card_updated":               "礼品卡已更新",
		"gift_card_deleted":               "礼品卡已删除",
		"gift_card_activated":             "礼品卡已激活",
		"gift_card_deactivated":           "礼品卡已停用",
		"gift_card_not_found":             "礼品卡未找到",
		"gift_card_already_exists":        "礼品卡已存在",
		"gift_card_expired":               "礼品卡已过期",
		"gift_card_used":                  "礼品卡已使用",
		"gift_card_balance_insufficient":   "礼品卡余额不足",
		"gift_card_amount_invalid":        "无效的礼品卡金额",
		"wallet_created":                  "钱包已创建",
		"wallet_updated":                  "钱包已更新",
		"wallet_deleted":                  "钱包已删除",
		"wallet_not_found":                "钱包未找到",
		"wallet_already_exists":           "钱包已存在",
		"wallet_balance_insufficient":     "钱包余额不足",
		"wallet_amount_invalid":           "无效的钱包金额",
		"wallet_transaction_created":      "钱包交易已创建",
		"wallet_transaction_failed":       "钱包交易失败",
		"wallet_transaction_not_found":    "钱包交易未找到",
		"billing_address_created":         "账单地址已创建",
		"billing_address_updated":         "账单地址已更新",
		"billing_address_deleted":         "账单地址已删除",
		"billing_address_not_found":       "账单地址未找到",
		"billing_address_invalid":         "无效的账单地址",
		"tax_info_created":                "税务信息已创建",
		"tax_info_updated":                "税务信息已更新",
		"tax_info_deleted":                "税务信息已删除",
		"tax_info_not_found":              "税务信息未找到",
		"tax_info_invalid":                "无效的税务信息",
		"currency_conversion_failed":      "货币转换失败",
		"exchange_rate_not_found":         "汇率未找到",
		"exchange_rate_invalid":           "无效的汇率",
		"payment_method_created":          "支付方式已创建",
		"payment_method_updated":          "支付方式已更新",
		"payment_method_deleted":          "支付方式已删除",
		"payment_method_not_found":        "支付方式未找到",
		"payment_method_already_default":  "支付方式已经是默认的",
		"payment_verification_required":   "需要支付验证",
		"payment_verification_sent":       "支付验证已发送",
		"payment_webhook_received":       "支付Webhook已接收",
		"payment_webhook_invalid":         "无效的支付Webhook",
		"payment_webhook_processed":      "支付Webhook已处理",
		"recurring_payment_created":       "循环支付已创建",
		"recurring_payment_updated":       "循环支付已更新",
		"recurring_payment_cancelled":     "循环支付已取消",
		"recurring_payment_failed":        "循环支付失败",
		"recurring_payment_not_found":     "循环支付未找到",
		"recurring_payment_already_exists": "循环支付已存在",
		"recurring_payment_schedule_invalid": "无效的循环支付计划",
	},
	LangEn: {
		"success":                         "Success",
		"error":                           "Error",
		"invalid_request":                 "Invalid request",
		"unauthorized":                    "Unauthorized",
		"forbidden":                       "Forbidden",
		"not_found":                       "Not found",
		"internal_server_error":           "Internal server error",
		"invalid_credentials":             "Invalid credentials",
		"user_not_found":                  "User not found",
		"email_already_exists":            "Email already exists",
		"invalid_email_format":            "Invalid email format",
		"password_too_short":              "Password too short",
		"password_too_long":               "Password too long",
		"invalid_birthday_format":         "Invalid birthday format",
		"invalid_gender":                  "Invalid gender",
		"bazi_calculation_failed":         "Bazi calculation failed",
		"ai_service_unavailable":          "AI service unavailable",
		"invalid_master_id":               "Invalid master ID",
		"master_not_found":                "Master not found",
		"invalid_chat_id":                 "Invalid chat ID",
		"chat_not_found":                  "Chat not found",
		"invalid_order_id":                "Invalid order ID",
		"order_not_found":                 "Order not found",
		"invalid_payment_method":          "Invalid payment method",
		"payment_failed":                  "Payment failed",
		"insufficient_balance":            "Insufficient balance",
		"invalid_invite_code":             "Invalid invite code",
		"invite_code_expired":             "Invite code expired",
		"invite_code_used":                "Invite code used",
		"file_upload_failed":              "File upload failed",
		"invalid_file_format":             "Invalid file format",
		"file_too_large":                  "File too large",
		"network_error":                   "Network error",
		"service_temporarily_unavailable": "Service temporarily unavailable",
		"maintenance_mode":                "Maintenance mode",
		"feature_disabled":                "Feature disabled",
		"rate_limit_exceeded":             "Rate limit exceeded",
		"invalid_token":                   "Invalid token",
		"token_expired":                   "Token expired",
		"token_revoked":                   "Token revoked",
		"session_expired":                 "Session expired",
		"invalid_permissions":             "Invalid permissions",
		"account_locked":                  "Account locked",
		"account_disabled":                "Account disabled",
		"verification_required":           "Verification required",
		"email_not_verified":              "Email not verified",
		"phone_not_verified":              "Phone not verified",
		"invalid_verification_code":       "Invalid verification code",
		"verification_code_expired":       "Verification code expired",
		"too_many_attempts":               "Too many attempts",
		"please_try_again_later":          "Please try again later",
		"operation_successful":            "Operation successful",
		"operation_failed":                "Operation failed",
		"data_saved":                      "Data saved",
		"data_deleted":                    "Data deleted",
		"data_updated":                    "Data updated",
		"no_data_found":                   "No data found",
		"invalid_parameters":              "Invalid parameters",
		"missing_required_parameters":     "Missing required parameters",
		"invalid_data_format":             "Invalid data format",
		"data_validation_failed":          "Data validation failed",
		"database_error":                  "Database error",
		"connection_failed":               "Connection failed",
		"timeout_error":                   "Timeout error",
		"configuration_error":             "Configuration error",
		"system_error":                    "System error",
		"token_generation_failed":         "Token generation failed",
		"password_set_failed":             "Password set failed",
		"user_creation_failed":            "User creation failed",
		"invalid_user_id_format":          "Invalid user ID format",
		"unknown_error":                   "Unknown error",
		// Additional common messages
		"chart_created":                   "Chart record created",
		"submit_failed":                   "Submission failed",
		"cache_cleared":                   "Cache cleared",
		"hint":                            "Hint",
		"input":                           "Input",
		"chinese":                         "Chinese",
		// Payment related
		"payment_successful":              "Payment successful",
		"payment_pending":                 "Payment pending",
		"payment_cancelled":               "Payment cancelled",
		"payment_refunded":                "Payment refunded",
		"payment_timeout":                 "Payment timeout",
		"payment_amount_invalid":          "Invalid payment amount",
		"payment_currency_invalid":        "Invalid currency",
		"payment_gateway_error":           "Payment gateway error",
		"payment_processing_error":        "Payment processing error",
		"payment_authorization_failed":    "Payment authorization failed",
		"payment_capture_failed":          "Payment capture failed",
		"payment_refund_failed":           "Refund failed",
		"payment_void_failed":             "Payment void failed",
		"payment_dispute_created":         "Payment dispute created",
		"payment_dispute_resolved":        "Payment dispute resolved",
		"payment_dispute_rejected":        "Payment dispute rejected",
		"subscription_created":            "Subscription created",
		"subscription_updated":            "Subscription updated",
		"subscription_cancelled":          "Subscription cancelled",
		"subscription_renewed":            "Subscription renewed",
		"subscription_expired":            "Subscription expired",
		"subscription_not_found":          "Subscription not found",
		"subscription_already_exists":     "Subscription already exists",
		"subscription_plan_not_found":     "Subscription plan not found",
		"subscription_plan_inactive":      "Subscription plan inactive",
		"subscription_upgrade_failed":     "Subscription upgrade failed",
		"subscription_downgrade_failed":   "Subscription downgrade failed",
		"membership_created":              "Membership created",
		"membership_updated":              "Membership updated",
		"membership_cancelled":            "Membership cancelled",
		"membership_expired":              "Membership expired",
		"membership_not_found":            "Membership not found",
		"membership_already_exists":       "Membership already exists",
		"membership_plan_not_found":       "Membership plan not found",
		"membership_plan_inactive":        "Membership plan inactive",
		"membership_upgrade_failed":       "Membership upgrade failed",
		"membership_downgrade_failed":     "Membership downgrade failed",
		"invoice_created":                 "Invoice created",
		"invoice_updated":                 "Invoice updated",
		"invoice_cancelled":               "Invoice cancelled",
		"invoice_paid":                    "Invoice paid",
		"invoice_overdue":                 "Invoice overdue",
		"invoice_not_found":               "Invoice not found",
		"invoice_already_exists":          "Invoice already exists",
		"invoice_already_paid":            "Invoice already paid",
		"invoice_already_cancelled":       "Invoice already cancelled",
		"refund_created":                  "Refund created",
		"refund_updated":                  "Refund updated",
		"refund_approved":                 "Refund approved",
		"refund_rejected":                 "Refund rejected",
		"refund_processed":                "Refund processed",
		"refund_not_found":                "Refund not found",
		"refund_already_exists":           "Refund already exists",
		"refund_already_processed":        "Refund already processed",
		"refund_amount_invalid":           "Invalid refund amount",
		"refund_reason_required":          "Refund reason required",
		"order_created":                   "Order created",
		"order_updated":                   "Order updated",
		"order_cancelled":                 "Order cancelled",
		"order_paid":                      "Order paid",
		"order_shipped":                   "Order shipped",
		"order_delivered":                 "Order delivered",
		"order_refunded":                  "Order refunded",
		"order_already_exists":            "Order already exists",
		"order_already_paid":               "Order already paid",
		"order_already_cancelled":          "Order already cancelled",
		"order_amount_invalid":            "Invalid order amount",
		"order_items_required":            "Order items required",
		"coupon_created":                  "Coupon created",
		"coupon_updated":                  "Coupon updated",
		"coupon_deleted":                  "Coupon deleted",
		"coupon_activated":                "Coupon activated",
		"coupon_deactivated":              "Coupon deactivated",
		"coupon_not_found":                "Coupon not found",
		"coupon_already_exists":           "Coupon already exists",
		"coupon_expired":                  "Coupon expired",
		"coupon_used":                     "Coupon used",
		"coupon_usage_limit_exceeded":     "Coupon usage limit exceeded",
		"coupon_invalid_for_user":         "Coupon invalid for user",
		"coupon_invalid_for_product":      "Coupon invalid for product",
		"coupon_minimum_amount_not_met":   "Minimum amount not met",
		"gift_card_created":               "Gift card created",
		"gift_card_updated":               "Gift card updated",
		"gift_card_deleted":               "Gift card deleted",
		"gift_card_activated":             "Gift card activated",
		"gift_card_deactivated":           "Gift card deactivated",
		"gift_card_not_found":             "Gift card not found",
		"gift_card_already_exists":        "Gift card already exists",
		"gift_card_expired":               "Gift card expired",
		"gift_card_used":                  "Gift card used",
		"gift_card_balance_insufficient":   "Gift card balance insufficient",
		"gift_card_amount_invalid":        "Invalid gift card amount",
		"wallet_created":                  "Wallet created",
		"wallet_updated":                  "Wallet updated",
		"wallet_deleted":                  "Wallet deleted",
		"wallet_not_found":                "Wallet not found",
		"wallet_already_exists":           "Wallet already exists",
		"wallet_balance_insufficient":     "Wallet balance insufficient",
		"wallet_amount_invalid":           "Invalid wallet amount",
		"wallet_transaction_created":      "Wallet transaction created",
		"wallet_transaction_failed":       "Wallet transaction failed",
		"wallet_transaction_not_found":    "Wallet transaction not found",
		"billing_address_created":         "Billing address created",
		"billing_address_updated":         "Billing address updated",
		"billing_address_deleted":         "Billing address deleted",
		"billing_address_not_found":       "Billing address not found",
		"billing_address_invalid":         "Invalid billing address",
		"tax_info_created":                "Tax info created",
		"tax_info_updated":                "Tax info updated",
		"tax_info_deleted":                "Tax info deleted",
		"tax_info_not_found":              "Tax info not found",
		"tax_info_invalid":                "Invalid tax info",
		"currency_conversion_failed":      "Currency conversion failed",
		"exchange_rate_not_found":         "Exchange rate not found",
		"exchange_rate_invalid":           "Invalid exchange rate",
		"payment_method_created":          "Payment method created",
		"payment_method_updated":          "Payment method updated",
		"payment_method_deleted":          "Payment method deleted",
		"payment_method_not_found":        "Payment method not found",
		"payment_method_already_default":  "Payment method already default",
		"payment_verification_required":   "Payment verification required",
		"payment_verification_sent":       "Payment verification sent",
		"payment_webhook_received":       "Payment webhook received",
		"payment_webhook_invalid":         "Invalid payment webhook",
		"payment_webhook_processed":      "Payment webhook processed",
		"recurring_payment_created":       "Recurring payment created",
		"recurring_payment_updated":       "Recurring payment updated",
		"recurring_payment_cancelled":     "Recurring payment cancelled",
		"recurring_payment_failed":        "Recurring payment failed",
		"recurring_payment_not_found":     "Recurring payment not found",
		"recurring_payment_already_exists": "Recurring payment already exists",
		"recurring_payment_schedule_invalid": "Invalid recurring payment schedule",
	},
}

var (
	messagesMutex sync.RWMutex
)

// GetMessage 获取指定语言的翻译消息
func GetMessage(lang, key string) string {
	messagesMutex.RLock()
	defer messagesMutex.RUnlock()

	// 如果语言不存在，默认使用中文
	if _, exists := messages[lang]; !exists {
		lang = LangZh
	}

	// 如果消息不存在，返回key
	if msg, exists := messages[lang][key]; exists {
		return msg
	}

	// 如果当前语言没有，尝试使用中文
	if lang != LangZh {
		if msg, exists := messages[LangZh][key]; exists {
			return msg
		}
	}

	return key
}

// GetMessageWithFormat 获取带格式的翻译消息
func GetMessageWithFormat(lang, key string, args ...interface{}) string {
	msg := GetMessage(lang, key)
	if len(args) > 0 {
		return fmt.Sprintf(msg, args...)
	}
	return msg
}

// GetSupportedLanguages 获取支持的语言列表
func GetSupportedLanguages() []string {
	return []string{LangZh, LangEn}
}

// IsLanguageSupported 检查语言是否支持
func IsLanguageSupported(lang string) bool {
	messagesMutex.RLock()
	defer messagesMutex.RUnlock()
	_, exists := messages[lang]
	return exists
}

// AddCustomMessage 添加自定义消息
func AddCustomMessage(lang, key, message string) {
	messagesMutex.Lock()
	defer messagesMutex.Unlock()

	if _, exists := messages[lang]; !exists {
		messages[lang] = make(map[string]string)
	}

	messages[lang][key] = message
}

// GetLanguageFromHeader 从HTTP头获取语言
func GetLanguageFromHeader(acceptLanguage string) string {
	if acceptLanguage == "" {
		return LangZh
	}

	// 简单的语言解析，可以根据需要扩展
	if acceptLanguage[0:2] == "en" {
		return LangEn
	}

	return LangZh
}